<html>
<head>
    <title>Dataviz</title>
    <script src="./neovis.js"></script>
    <!-- unpkg CDN non-minified -->
    <script src="https://unpkg.com/neo4j-driver"></script>
</head>
<body>
<h3>选择想要显示的标签：</h3>
<select id="label_select"></select>
<h3>输入标签内容：</h3>
<input type="text" id="text_input">
<button onclick="generate_query()">筛选！</button>
<div id="viz"></div>
<script>
    var labels = [];
    var query = "";
    const neo4j_address = 'bolt://54.147.68.158:7687';
    const neo4j_username = 'neo4j';
    const neo4j_password = 'initiators-futures-monitor';
    var config;
    function require_labels() {
        // 创建一个Neo4j驱动程序
        const driver = neo4j.driver(neo4j_address, neo4j.auth.basic(neo4j_username, neo4j_password));
        console.log(driver);
        // 创建一个会话（session）
        const session = driver.session();

        // 编写Cypher查询语句，获取所有可能的标签
        const labels_query = 'CALL db.labels()';

        // 运行Cypher查询
        session.run(labels_query)
            .then(result => {
                // 处理查询结果
                labels = result.records.map(record => record.get(0));
                console.log(labels);
                setupDropdown();
            })
            .catch(error => {
                console.error('Error retrieving labels:', error);
            })
            .finally(() => {
                // 关闭会话和驱动程序
                session.close();
                driver.close();
            });
    }

    function setupDropdown() {
        const dropdown = document.getElementById('label_select');
        dropdown.innerHTML = '';
        labels.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.text = option;
            dropdown.appendChild(optionElement);
        });
    }

    window.onload = function () {
        require_labels();
        draw_all();
    }
    function draw_all(){
        query = "MATCH (n)-[r]->(m) return n,r,m LIMIT 200";
        config = {
            containerId: "viz",
            neo4j: {
                serverUrl: neo4j_address,
                serverUser: neo4j_username,
                serverPassword: neo4j_password
            },
            labels: {
                "Tag": {
                    caption: "name",
                    label: "name"
                },
                "File": {
                    caption: "name",
                    label: "name"
                }
            },
            relationships: {
                "PLAYED_IN": {
                    caption: false,
                    thickness: "score"
                }
            },
            initialCypher: query
        }
        console.log("123");
        draw();
    }
    function generate_query() {
        const dropdown_value = document.getElementById("label_select").value;
        const text_input_value = document.getElementById("text_input").value;
        query = "MATCH p=(n:"+dropdown_value+")-[r]->(m) WHERE n.name=\'" + text_input_value + "\' RETURN n,r,m";
        //console.log(query);
        config ={
            containerId: "viz",
            neo4j: {
                serverUrl: neo4j_address,
                serverUser: neo4j_username,
                serverPassword: neo4j_password
            },
            labels: {
                "Team": {
                    caption: "name",
                    label: "name"
                },
                "Match": {
                    caption: "stage",
                    label: "stage"
                }
            },
            relationships: {
                "PLAYED_IN": {
                    caption: false,
                    thickness: "score"
                }
            },
            initialCypher: query
        }
        draw();
    }
    function draw() {
        var viz = new NeoVis.default(config);
        viz.render();
    }
</script>
</body>
</html>
